<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Equities Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Energy Industry Color Palette */
            --bg-primary: #0a0e1a;
            --bg-secondary: #131722;
            --bg-tertiary: #1e222d;
            --bg-card: #1e2329;
            --bg-card-hover: #252831;
            
            /* Energy Companies */
            --company-primary: #00d4aa;
            --company-secondary: #00a8ff;
            --company-gradient: linear-gradient(135deg, #00d4aa 0%, #00a8ff 100%);
            
            /* Oil Services */
            --services-primary: #ff6b6b;
            --services-secondary: #ee5a24;
            --services-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            
            /* Performance Colors */
            --energy-green: #00ff88;
            --energy-red: #ff4757;
            --energy-green-bg: rgba(0, 255, 136, 0.1);
            --energy-red-bg: rgba(255, 71, 87, 0.1);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #b2b5be;
            --text-tertiary: #787b86;
            --text-accent: #00d4aa;
            
            /* Border Colors */
            --border-primary: #2a2e39;
            --border-secondary: #363c4e;
            --border-accent: rgba(0, 212, 170, 0.3);
            
            /* Monospace Font for Numbers */
            --font-mono: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
        }

        /* Enhanced Typography */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
        }

        .header h1 {
            font-size: 3.2em;
            font-weight: 700;
            margin-bottom: 12px;
            background: var(--company-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }

        .last-updated {
            font-family: var(--font-mono);
            font-size: 0.95em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .api-status {
            margin-top: 15px;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.9em;
            border: 1px solid var(--border-secondary);
            font-family: var(--font-mono);
        }

        /* Professional Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .control-group input {
            padding: 10px 14px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-mono);
            transition: all 0.2s ease;
        }

        .control-group input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        .control-group input::placeholder {
            color: var(--text-tertiary);
        }

        .btn {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9em;
        }

        .btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-accent);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Enhanced Market Summary */
        .market-summary {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid var(--border-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-secondary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 212, 170, 0.15);
            border-color: var(--text-accent);
        }

        .summary-title {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 1.6em;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        /* Professional News Section */
        .news-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid var(--border-primary);
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .news-item {
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border-left: 3px solid var(--text-accent);
            transition: all 0.3s ease;
            border: 1px solid var(--border-secondary);
        }

        .news-item:hover {
            background: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .news-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95em;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .news-source {
            font-size: 0.8em;
            color: var(--text-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .news-source span {
            font-weight: 500;
        }

        .news-link {
            color: var(--text-accent);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .news-link:hover {
            color: var(--energy-green);
            background: rgba(0, 212, 170, 0.1);
        }

        /* Professional Section Headers */
        .section {
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 2em;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 700;
            position: relative;
            padding-bottom: 15px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--text-accent);
            border-radius: 2px;
        }

        /* Enhanced Grid Layout */
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 20px;
        }

        /* Professional Price Cards */
        .price-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            min-height: 240px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 212, 170, 0.03) 100%);
        }

        .price-card.services {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255, 107, 107, 0.03) 100%);
        }

        /* Conditional Formatting for Major Moves */
        .price-card.major-gain {
            background: var(--energy-green-bg);
            border-color: var(--energy-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .price-card.major-loss {
            background: var(--energy-red-bg);
            border-color: var(--energy-red);
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.2);
        }

        .price-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--text-accent);
        }

        .price-card.expanded {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        /* Enhanced Top Border Indicators */
        .price-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 12px 12px 0 0;
            background: var(--company-gradient);
        }

        .price-card.services::before {
            background: var(--services-gradient);
        }

        /* Enhanced Symbol Display */
        .symbol {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            letter-spacing: 0.5px;
        }

        .company-name {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 18px;
            line-height: 1.3;
            font-weight: 500;
        }

        /* Professional Price Display */
        .price {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 12px;
            font-family: var(--font-mono);
            letter-spacing: -0.5px;
        }

        .change {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .change-amount {
            font-size: 1.1em;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .change-percent {
            font-size: 0.9em;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-family: var(--font-mono);
            letter-spacing: 0.3px;
        }

        .positive {
            color: var(--energy-green);
        }

        .negative {
            color: var(--energy-red);
        }

        .positive .change-percent {
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .negative .change-percent {
            background: rgba(255, 71, 87, 0.15);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px 20px;
            font-size: 1.1em;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-tertiary);
            border-radius: 50%;
            border-top-color: var(--text-accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-live {
            background: var(--energy-green);
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-error {
            background: var(--energy-red);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Advanced Charts Container */
        .price-chart {
            height: 60px;
            margin-top: 20px;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid var(--border-secondary);
        }

        .chart-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .price-line {
            fill: none;
            stroke: var(--company-primary);
            stroke-width: 2;
            filter: drop-shadow(0 0 4px currentColor);
        }

        .services .price-line {
            stroke: var(--services-primary);
        }

        .chart-area {
            fill: var(--company-primary);
            opacity: 0.15;
        }

        .services .chart-area {
            fill: var(--services-primary);
        }

        /* Professional Tooltips */
        .tooltip {
            position: absolute;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85em;
            font-family: var(--font-mono);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .tooltip-data {
            display: grid;
            grid-template-columns: auto auto;
            gap: 8px 16px;
            color: var(--text-secondary);
        }

        .tooltip-label {
            font-weight: 500;
        }

        .tooltip-value {
            text-align: right;
            color: var(--text-primary);
        }

        /* Enhanced Debug Panel */
        .debug-panel {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: var(--font-mono);
            font-size: 0.8em;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-secondary);
        }

        .debug-title {
            color: var(--text-accent);
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .api-stats {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.9em;
            border: 1px solid var(--border-primary);
        }

        /* Deployment Status */
        .deployment-info {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid var(--border-accent);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.4em;
            }
            
            .companies-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .news-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .price {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⛽ Energy Equities Terminal</h1>
            <div class="last-updated">Last updated: <span id="lastUpdate">Initializing...</span></div>
            <div class="api-status">
                📡 <strong>Market Data Status:</strong> <span id="apiStatus">Connecting to live data sources...</span>
            </div>
            <div class="deployment-info">
                🚀 <strong>Energy Equities Terminal v3.0:</strong> Simplified focus on key O&G securities.
                Real-time updates every 2 minutes via Finnhub. Regulatory & legal news updates every 10 minutes (past 7 days only).
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Add Symbol:</label>
                <input type="text" id="symbolInput" placeholder="e.g., XOM, SLB" maxlength="10">
                <button class="btn" onclick="addSymbol()">Add</button>
            </div>
            <div class="control-group">
                <button class="btn" onclick="toggleUpdates()" id="toggleBtn">⏸️ Pause</button>
                <button class="btn" onclick="refreshAll()" id="refreshAllBtn">🔄 Refresh All</button>
                <button class="btn" onclick="toggleDebug()">🔍 Debug</button>
            </div>
        </div>

        <!-- Debug Panel -->
        <div id="debugPanel" class="debug-panel" style="display: none;">
            <div class="debug-title">🔍 API Monitoring</div>
            <div class="api-stats" id="apiStats">
                <strong>Data Source Performance:</strong><br>
                • Finnhub Pro: <span id="finnhubStats">Not tested</span><br>
                • News Sources: <span id="newsApiStats">Not tested</span>
            </div>
            <div id="debugLog"></div>
        </div>

        <!-- Market Summary Section -->
        <div class="market-summary">
            <h2 style="text-align: center; margin-bottom: 25px; font-size: 1.8em; font-weight: 700;">📊 Energy Market Overview</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-title">Sector Average</div>
                    <div class="summary-value" id="sectorAvg">Loading...</div>
                </div>
                <div class="summary-item">
                    <div class="summary-title">Top Gainer</div>
                    <div class="summary-value" id="topGainer">Loading...</div>
                </div>
                <div class="summary-item">
                    <div class="summary-title">Top Loser</div>
                    <div class="summary-value" id="topLoser">Loading...</div>
                </div>
                <div class="summary-item">
                    <div class="summary-title">Active Stocks</div>
                    <div class="summary-value" id="activeStocks">Loading...</div>
                </div>
            </div>
        </div>

        <!-- News Section -->
        <div class="news-section">
            <h2 style="text-align: center; margin-bottom: 25px; font-size: 1.8em; font-weight: 700;">📰 Energy Regulatory & Market News</h2>
            <div id="newsStatus" style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">Loading energy news...</div>
            <div style="text-align: center; margin-bottom: 15px; font-size: 0.85em; color: var(--text-tertiary);">
                Focus: Pipeline regulations, drilling permits, legal challenges, FERC/EPA updates
            </div>
            <div id="newsContainer" class="news-grid">
                <div class="loading">Fetching latest energy industry news...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">🏭 Energy Companies & Services</h2>
            <div id="companiesGrid" class="companies-grid">
                <div class="loading">Loading live market data...</div>
            </div>
        </div>

        <!-- Tooltip -->
        <div id="tooltip" class="tooltip">
            <div class="tooltip-title"></div>
            <div class="tooltip-data"></div>
        </div>
    </div>

    <script>
        'use strict';

        // ============= API CONFIGURATION =============
        const API_KEYS = {
            FINNHUB: 'd20i9lpr01qrk6cl5adgd20i9lpr01qrk6cl5ae0',
            CURRENTS: '5vexUPN43TdFfjFM_BdejcR9lnE_JyDHU-ceWHbIb-GG4Iy5',
            GNEWS: '22b87731ed1048479c91c7b1831303ca'
        };
        
        // All energy companies including services
        const energyCompanies = [
            // Major Oil Companies
            'XOM', 'CVX', 'COP', 
            // E&P Companies
            'EOG', 'EQT', 
            // Midstream
            'KMI', 'EPD', 'ET', 'WMB',
            // Refiners
            'VLO', 'PSX', 'MPC',
            // Oilfield Services
            'SLB', 'HAL', 'BKR'
        ];
        
        // Track which are services for styling
        const servicesCompanies = ['SLB', 'HAL', 'BKR'];
        
        // Refresh configuration
        const REFRESH_CONFIG = {
            stocks: {
                interval: 2 * 60000,  // 2 minutes
                lastUpdate: null
            },
            news: {
                interval: 10 * 60000,  // 10 minutes
                lastUpdate: null
            }
        };

        // Global state
        let stockInterval;
        let newsInterval;
        let isUpdating = true;
        let priceHistory = {};
        let priceData = {};
        let debugMode = false;
        let debugLog = [];
        let expandedCard = null;
        
        // Performance optimization
        const domCache = {};
        const energyTermsRegex = /\b(oil|gas|energy|crude|petroleum|opec|drilling|pipeline|shale|lng|refinery|barrel|regulation|regulatory|compliance|permit|legal|lawsuit|litigation|FERC|EPA|infrastructure)\b/i;
        
        // API statistics
        let apiStats = {
            finnhub: { success: 0, failed: 0 },
            currents: { success: 0, failed: 0 },
            gnews: { success: 0, failed: 0 },
            rss: { success: 0, failed: 0 }
        };

        // Initialize data structures
        energyCompanies.forEach(symbol => {
            priceHistory[symbol] = [];
        });

        // ============= UTILITY FUNCTIONS =============
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function sanitizeSymbol(symbol) {
            return symbol.replace(/[^A-Z0-9\-\.]/g, '').substring(0, 10);
        }

        function initializeDomCache() {
            domCache.lastUpdate = document.getElementById('lastUpdate');
            domCache.apiStatus = document.getElementById('apiStatus');
            domCache.sectorAvg = document.getElementById('sectorAvg');
            domCache.topGainer = document.getElementById('topGainer');
            domCache.topLoser = document.getElementById('topLoser');
            domCache.activeStocks = document.getElementById('activeStocks');
            domCache.toggleBtn = document.getElementById('toggleBtn');
            domCache.refreshAllBtn = document.getElementById('refreshAllBtn');
            domCache.symbolInput = document.getElementById('symbolInput');
            domCache.newsContainer = document.getElementById('newsContainer');
            domCache.newsStatus = document.getElementById('newsStatus');
            domCache.debugPanel = document.getElementById('debugPanel');
            domCache.debugLog = document.getElementById('debugLog');
            domCache.companiesGrid = document.getElementById('companiesGrid');
        }

        // ============= CHART FUNCTIONS =============
        function createSimpleChart(symbol, priceHistory) {
            const history = priceHistory[symbol] || [];
            if (history.length < 2) return '';
            
            const width = 100;
            const height = 100;
            const prices = history.slice(-20); // Last 20 points
            
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);
            const priceRange = maxPrice - minPrice || 1;
            
            // Create path
            const points = prices.map((price, i) => {
                const x = (i / (prices.length - 1)) * width;
                const y = height - ((price - minPrice) / priceRange) * height;
                return `${x},${y}`;
            });
            
            const linePath = `M${points.join(' L')}`;
            const areaPath = `${linePath} L${width},${height} L0,${height} Z`;
            
            const isServices = servicesCompanies.includes(symbol);
            
            return `
                <div class="chart-container ${isServices ? 'services' : ''}">
                    <svg class="chart-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                        <path d="${areaPath}" class="chart-area" />
                        <path d="${linePath}" class="price-line" />
                    </svg>
                </div>
            `;
        }

        // ============= TOOLTIP SYSTEM =============
        function showTooltip(event, symbol, data) {
            const tooltip = document.getElementById('tooltip');
            const title = tooltip.querySelector('.tooltip-title');
            const dataContainer = tooltip.querySelector('.tooltip-data');
            
            title.textContent = `${symbol} - ${getCompanyName(symbol)}`;
            
            const tooltipData = [
                ['Price', '$' + data.price.toFixed(2)],
                ['Change', `${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}`],
                ['Change %', `${data.changePercent >= 0 ? '+' : ''}${data.changePercent.toFixed(2)}%`],
                ['Status', data.isLive ? 'Live Data' : 'Delayed'],
                ['Updated', new Date().toLocaleTimeString()]
            ];
            
            dataContainer.innerHTML = tooltipData.map(([label, value]) => 
                `<span class="tooltip-label">${label}:</span><span class="tooltip-value">${value}</span>`
            ).join('');
            
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // ============= CARD EXPAND FUNCTIONALITY =============
        function toggleExpandCard(cardElement) {
            if (expandedCard && expandedCard !== cardElement) {
                expandedCard.classList.remove('expanded');
            }
            
            cardElement.classList.toggle('expanded');
            expandedCard = cardElement.classList.contains('expanded') ? cardElement : null;
        }

        // ============= DEBUG FUNCTIONS =============
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            debugLog.push(logEntry);
            if (debugLog.length > 100) debugLog.shift();
            updateDebugDisplay();
        }

        function updateDebugDisplay() {
            if (debugMode && domCache.debugLog) {
                domCache.debugLog.innerHTML = debugLog.slice(-25).join('<br>');
                domCache.debugLog.scrollTop = domCache.debugLog.scrollHeight;
            }
        }

        function updateApiStats() {
            const finnhubEl = document.getElementById('finnhubStats');
            const newsEl = document.getElementById('newsApiStats');
            
            if (finnhubEl) finnhubEl.innerHTML = `${apiStats.finnhub.success} success, ${apiStats.finnhub.failed} failed`;
            if (newsEl) newsEl.innerHTML = `Currents: ${apiStats.currents.success}/${apiStats.currents.failed}, GNews: ${apiStats.gnews.success}/${apiStats.gnews.failed}, RSS: ${apiStats.rss.success}/${apiStats.rss.failed}`;
        }

        function toggleDebug() {
            debugMode = !debugMode;
            if (domCache.debugPanel) {
                domCache.debugPanel.style.display = debugMode ? 'block' : 'none';
            }
            updateDebugDisplay();
            updateApiStats();
        }

        function updateStatus(message) {
            if (domCache.apiStatus) {
                domCache.apiStatus.textContent = message;
            }
            log(message);
        }

        // ============= COMPANY DATA =============
        function getBasePrices() {
            return {
                'XOM': 109.48, 'CVX': 150.04, 'COP': 107.25, 
                'EOG': 121.30, 'EQT': 39.85,
                'KMI': 27.84, 'EPD': 31.18, 'ET': 16.95, 'WMB': 57.82,
                'VLO': 131.75, 'PSX': 115.20, 'MPC': 148.60,
                'SLB': 42.50, 'HAL': 32.75, 'BKR': 34.20
            };
        }

        function getCompanyName(symbol) {
            const names = {
                'XOM': 'Exxon Mobil Corporation', 
                'CVX': 'Chevron Corporation', 
                'COP': 'ConocoPhillips',
                'EOG': 'EOG Resources, Inc.', 
                'EQT': 'EQT Corporation', 
                'KMI': 'Kinder Morgan, Inc.',
                'EPD': 'Enterprise Products Partners', 
                'ET': 'Energy Transfer LP', 
                'WMB': 'The Williams Companies',
                'VLO': 'Valero Energy Corporation', 
                'PSX': 'Phillips 66', 
                'MPC': 'Marathon Petroleum',
                'SLB': 'Schlumberger Limited', 
                'HAL': 'Halliburton Company', 
                'BKR': 'Baker Hughes Company'
            };
            return names[symbol] || symbol;
        }

        function generateRealisticPrice(symbol, lastPrice = null) {
            const basePrices = getBasePrices();
            const basePrice = lastPrice || basePrices[symbol] || 100;
            
            const volatility = 0.010;
            const trend = Math.sin(Date.now() / 200000) * 0.003;
            const random = (Math.random() - 0.5) * 2 * volatility;
            const change = trend + random;
            
            const newPrice = Math.max(0.01, basePrice * (1 + change));
            const priceChange = newPrice - basePrice;
            const percentChange = (priceChange / basePrice) * 100;
            
            return {
                price: newPrice,
                change: priceChange,
                changePercent: percentChange,
                isLive: false
            };
        }

        // ============= FINNHUB API =============
        async function fetchFromFinnhub(symbol) {
            try {
                const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEYS.FINNHUB}`;
                
                log(`🔄 Finnhub: Fetching ${symbol}`);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.c && data.c > 0) {
                    const change = data.d || 0;
                    const changePercent = data.dp || 0;
                    
                    apiStats.finnhub.success++;
                    log(`✅ Finnhub: ${symbol} = $${data.c.toFixed(2)} (${changePercent.toFixed(2)}%)`);
                    
                    return {
                        price: data.c,
                        change: change,
                        changePercent: changePercent,
                        isLive: true,
                        source: 'Finnhub'
                    };
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                apiStats.finnhub.failed++;
                log(`❌ Finnhub: ${symbol} failed - ${error.message}`);
                return null;
            }
        }

        // ============= NEWS APIS =============
        async function fetchFromCurrentsAPI() {
            try {
                // Get date 7 days ago for freshness
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const startDate = weekAgo.toISOString();
                
                // Targeted search terms for regulatory/legal energy news
                const searchTerms = [
                    'pipeline%20regulation',
                    'drilling%20permits',
                    'oil%20gas%20litigation',
                    'energy%20regulatory',
                    'FERC%20pipeline',
                    'EPA%20oil%20gas',
                    'fracking%20regulation',
                    'offshore%20drilling%20policy',
                    'energy%20infrastructure%20legal'
                ].join('%20OR%20');
                
                const url = `https://api.currentsapi.services/v1/search?keywords=${searchTerms}&language=en&start_date=${startDate}&apiKey=${API_KEYS.CURRENTS}`;
                
                log(`🔄 CurrentsAPI: Fetching recent regulatory energy news`);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.news && data.news.length > 0) {
                    // Filter for recent articles (within 7 days) and sort by date
                    const recentNews = data.news
                        .filter(item => {
                            const publishDate = new Date(item.published);
                            const daysDiff = (Date.now() - publishDate) / (1000 * 60 * 60 * 24);
                            return daysDiff <= 7 && (
                                energyTermsRegex.test(item.title) || 
                                (item.description && energyTermsRegex.test(item.description))
                            );
                        })
                        .sort((a, b) => new Date(b.published) - new Date(a.published))
                        .slice(0, 6);
                    
                    const newsItems = recentNews.map(item => ({
                        title: item.title,
                        url: item.url || '#',
                        source: item.author || 'CurrentsAPI',
                        time: item.published,
                        daysAgo: Math.floor((Date.now() - new Date(item.published)) / (1000 * 60 * 60 * 24))
                    }));
                    
                    if (newsItems.length > 0) {
                        apiStats.currents.success++;
                        log(`✅ CurrentsAPI: Loaded ${newsItems.length} recent articles`);
                        // Debug log first URL
                        if (newsItems[0].url) {
                            log(`First article URL: ${newsItems[0].url.substring(0, 50)}...`);
                        }
                        return newsItems;
                    }
                }
                throw new Error('No recent relevant news found');
            } catch (error) {
                apiStats.currents.failed++;
                log(`❌ CurrentsAPI failed: ${error.message}`);
                return null;
            }
        }

        async function fetchFromGNews() {
            try {
                // GNews supports from/to date parameters
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const fromDate = weekAgo.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // More targeted boolean search for regulatory/legal energy news
                const query = [
                    'oil%20gas%20regulation',
                    'pipeline%20legal',
                    'drilling%20lawsuit',
                    'energy%20compliance',
                    'OPEC%20policy',
                    'shale%20permits',
                    'refinery%20regulatory',
                    'natural%20gas%20infrastructure'
                ].join('%20OR%20');
                
                const url = `https://gnews.io/api/v4/search?q=${query}&lang=en&max=10&from=${fromDate}&sortby=publishedAt&apikey=${API_KEYS.GNEWS}`;
                
                log(`🔄 GNews: Fetching recent energy regulatory news`);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.articles && data.articles.length > 0) {
                    // Additional filtering and sorting by recency
                    const recentArticles = data.articles
                        .filter(item => {
                            const publishDate = new Date(item.publishedAt);
                            const daysDiff = (Date.now() - publishDate) / (1000 * 60 * 60 * 24);
                            return daysDiff <= 7 && (
                                energyTermsRegex.test(item.title) || 
                                energyTermsRegex.test(item.description)
                            );
                        })
                        .sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt))
                        .slice(0, 6);
                    
                    const newsItems = recentArticles.map(item => ({
                        title: item.title,
                        url: item.url,
                        source: item.source.name || 'GNews',
                        time: item.publishedAt,
                        daysAgo: Math.floor((Date.now() - new Date(item.publishedAt)) / (1000 * 60 * 60 * 24))
                    }));
                    
                    if (newsItems.length > 0) {
                        apiStats.gnews.success++;
                        log(`✅ GNews: Loaded ${newsItems.length} recent articles`);
                        return newsItems;
                    }
                }
                throw new Error('No recent relevant news found');
            } catch (error) {
                apiStats.gnews.failed++;
                log(`❌ GNews failed: ${error.message}`);
                return null;
            }
        }

        // ============= RSS FEED BACKUP =============
        async function fetchFromRSSFeeds() {
            try {
                // Try specialized energy RSS feeds for very fresh content
                const rssFeeds = [
                    {
                        name: 'Oil & Gas Journal',
                        url: 'https://api.rss2json.com/v1/api.json?rss_url=https://www.ogj.com/rss&count=5'
                    },
                    {
                        name: 'Reuters Energy',
                        url: 'https://api.rss2json.com/v1/api.json?rss_url=https://www.reuters.com/business/energy/rss&count=5'
                    }
                ];
                
                const allRssNews = [];
                
                for (const feed of rssFeeds) {
                    try {
                        const response = await fetch(feed.url);
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.status === 'ok' && data.items && data.items.length > 0) {
                                const recentItems = data.items.filter(item => {
                                    const publishDate = new Date(item.pubDate);
                                    const daysDiff = (Date.now() - publishDate) / (1000 * 60 * 60 * 24);
                                    return daysDiff <= 3; // Only last 3 days for RSS
                                });
                                
                                const newsItems = recentItems.map(item => ({
                                    title: item.title,
                                    url: item.link,
                                    source: feed.name,
                                    time: item.pubDate,
                                    daysAgo: Math.floor((Date.now() - new Date(item.pubDate)) / (1000 * 60 * 60 * 24))
                                }));
                                
                                allRssNews.push(...newsItems);
                            }
                        }
                    } catch (error) {
                        apiStats.rss.failed++;
                        log(`RSS feed ${feed.name} failed: ${error.message}`);
                    }
                }
                
                return allRssNews;
            } catch (error) {
                log(`RSS feeds failed: ${error.message}`);
                return [];
            }
        }

        async function fetchNews() {
            log('📰 Fetching recent news...');
            updateNewsStatus('🔍 Loading recent regulatory & market news...');
            
            let allNews = [];
            
            // Try RSS feeds first for freshest content
            const rssNews = await fetchFromRSSFeeds();
            if (rssNews.length > 0) {
                allNews = [...allNews, ...rssNews];
                log(`✅ RSS: Loaded ${rssNews.length} very recent articles`);
            }
            
            // Then try regular news APIs
            const currentsNews = await fetchFromCurrentsAPI();
            if (currentsNews) allNews = [...allNews, ...currentsNews];
            
            const gnewsItems = await fetchFromGNews();
            if (gnewsItems) allNews = [...allNews, ...gnewsItems];
            
            if (allNews.length > 0) {
                // Remove duplicates and sort by date (most recent first)
                const uniqueNews = Array.from(
                    new Map(allNews.map(item => [item.title, item])).values()
                ).sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // Validate URLs before display
                const validatedNews = uniqueNews.map(item => ({
                    ...item,
                    url: validateUrl(item.url)
                }));
                
                displayNews(validatedNews.slice(0, 12));
                updateNewsStatus(`✅ Showing ${validatedNews.length} articles from the past week`);
                log(`✅ Total recent news items loaded: ${validatedNews.length}`);
            } else {
                updateNewsStatus('❌ No recent news available - showing examples');
                displayFallbackNews();
            }
        }
        
        function validateUrl(url) {
            if (!url || url === '#' || url === 'null' || url === 'undefined') {
                return '#';
            }
            
            // If URL doesn't start with http:// or https://, add https://
            if (!url.match(/^https?:\/\//i)) {
                return 'https://' + url;
            }
            
            return url;
        }

        function displayNews(newsItems) {
            if (!domCache.newsContainer) return;
            
            const newsHtml = newsItems.map(item => {
                // Format the time display
                let timeDisplay = '';
                if (item.daysAgo === 0) {
                    timeDisplay = 'Today';
                } else if (item.daysAgo === 1) {
                    timeDisplay = 'Yesterday';
                } else {
                    timeDisplay = `${item.daysAgo} days ago`;
                }
                
                const isValidUrl = item.url && item.url !== '#';
                
                return `
                    <div class="news-item">
                        <div class="news-title">${item.title}</div>
                        <div class="news-source">
                            <span>${item.source} • ${timeDisplay}</span>
                            ${isValidUrl ? 
                                `<a href="${item.url}" target="_blank" rel="noopener noreferrer" class="news-link">Read More →</a>` : 
                                '<span style="color: var(--text-tertiary); font-size: 0.85em;">No link available</span>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            domCache.newsContainer.innerHTML = newsHtml;
        }

        function displayFallbackNews() {
            const fallbackNews = [
                { 
                    title: 'FERC Denies Rehearing Request for Mountain Valley Pipeline Certificate Challenge', 
                    source: 'Energy Legal News', 
                    url: '#',
                    daysAgo: 0
                },
                { 
                    title: 'EPA Proposes Stricter Methane Rules for Oil and Gas Drilling Operations', 
                    source: 'Regulatory Watch', 
                    url: '#',
                    daysAgo: 0
                },
                { 
                    title: 'Federal Court Rules on Interstate Natural Gas Pipeline Eminent Domain Case', 
                    source: 'Infrastructure Today', 
                    url: '#',
                    daysAgo: 1
                },
                { 
                    title: 'Texas Railroad Commission Updates Well Permitting Process After Industry Pushback', 
                    source: 'Oil & Gas Journal', 
                    url: '#',
                    daysAgo: 1
                },
                { 
                    title: 'Energy Companies File Lawsuit Against New BLM Drilling Restrictions', 
                    source: 'Drilling Contractor', 
                    url: '#',
                    daysAgo: 2
                },
                { 
                    title: 'DC Circuit Hears Arguments in Pipeline Rate Case Affecting Multiple Operators', 
                    source: 'Policy Review', 
                    url: '#',
                    daysAgo: 2
                }
            ];
            displayNews(fallbackNews);
        }

        function updateNewsStatus(message) {
            if (domCache.newsStatus) {
                domCache.newsStatus.textContent = message;
            }
        }

        // ============= DISPLAY FUNCTIONS =============
        function renderPriceCards() {
            if (!domCache.companiesGrid) return;
            
            const html = energyCompanies.map(symbol => {
                const data = priceData[symbol];
                if (!data) return '';
                
                const isPositive = data.change >= 0;
                const statusClass = isUpdating ? (data.isLive ? 'status-live' : 'status-error') : 'status-error';
                const dataSource = data.isLive ? '📡 LIVE' : '📊 DELAYED';
                const isServices = servicesCompanies.includes(symbol);
                
                // Conditional formatting for major moves
                let majorMoveClass = '';
                if (Math.abs(data.changePercent) > 3) {
                    majorMoveClass = data.changePercent > 0 ? 'major-gain' : 'major-loss';
                }
                
                return `
                    <div class="price-card ${isServices ? 'services' : ''} ${majorMoveClass}" 
                         data-symbol="${symbol}" 
                         onmouseenter="showTooltip(event, '${symbol}', ${JSON.stringify(data).replace(/"/g, '&quot;')})"
                         onmouseleave="hideTooltip()"
                         onclick="toggleExpandCard(this)">
                        <div class="symbol">
                            ${symbol} <span style="font-size: 0.7em; opacity: 0.7;">${dataSource}</span>
                            <span class="status-indicator ${statusClass}"></span>
                        </div>
                        <div class="company-name">${data.name}</div>
                        <div class="price">$${data.price.toFixed(2)}</div>
                        <div class="change ${isPositive ? 'positive' : 'negative'}">
                            <span class="change-amount">${isPositive ? '+' : ''}${data.change.toFixed(2)}</span>
                            <span class="change-percent">${isPositive ? '+' : ''}${data.changePercent.toFixed(2)}%</span>
                        </div>
                        <div class="price-chart">${createSimpleChart(symbol, priceHistory)}</div>
                    </div>
                `;
            }).join('');
            
            domCache.companiesGrid.innerHTML = html;
        }

        function updateMarketSummary() {
            try {
                const allData = Object.values(priceData).filter(d => d && typeof d.changePercent === 'number');
                if (allData.length === 0) return;
                
                // Sector average
                const sectorAvg = allData.reduce((sum, d) => sum + d.changePercent, 0) / allData.length;
                
                // Top gainer and loser
                const topGainer = allData.reduce((max, d) => d.changePercent > max.changePercent ? d : max, allData[0]);
                const topLoser = allData.reduce((min, d) => d.changePercent < min.changePercent ? d : min, allData[0]);
                
                // Active stocks count
                const activeCount = allData.filter(d => d.isLive).length;
                
                // Update display
                if (domCache.sectorAvg) {
                    domCache.sectorAvg.innerHTML = `<span class="${sectorAvg >= 0 ? 'positive' : 'negative'}">${sectorAvg.toFixed(2)}%</span>`;
                }
                if (domCache.topGainer) {
                    domCache.topGainer.innerHTML = `<span class="positive">${topGainer.symbol} +${topGainer.changePercent.toFixed(2)}%</span>`;
                }
                if (domCache.topLoser) {
                    domCache.topLoser.innerHTML = `<span class="negative">${topLoser.symbol} ${topLoser.changePercent.toFixed(2)}%</span>`;
                }
                if (domCache.activeStocks) {
                    domCache.activeStocks.textContent = `${activeCount}/${allData.length}`;
                }
            } catch (error) {
                log(`❌ Error updating market summary: ${error.message}`);
            }
        }

        // ============= UPDATE FUNCTIONS =============
        async function updateStocks() {
            log('📈 Updating stocks...');
            updateStatus('📈 Updating stock prices...');
            
            if (domCache.refreshAllBtn) domCache.refreshAllBtn.disabled = true;
            
            let liveCount = 0;
            
            // Process all stocks
            for (const symbol of energyCompanies) {
                const data = await fetchFromFinnhub(symbol);
                
                if (data) {
                    priceData[symbol] = {
                        ...data,
                        name: getCompanyName(symbol),
                        symbol: symbol
                    };
                    liveCount++;
                } else {
                    // Use simulation if API fails
                    const lastPrice = priceHistory[symbol] && priceHistory[symbol].length > 0 ? 
                        priceHistory[symbol][priceHistory[symbol].length - 1] : null;
                    const simulatedData = generateRealisticPrice(symbol, lastPrice);
                    
                    priceData[symbol] = {
                        ...simulatedData,
                        name: getCompanyName(symbol),
                        symbol: symbol
                    };
                }
                
                // Update price history
                if (!priceHistory[symbol]) priceHistory[symbol] = [];
                priceHistory[symbol].push(priceData[symbol].price);
                if (priceHistory[symbol].length > 50) {
                    priceHistory[symbol].shift();
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            renderPriceCards();
            updateMarketSummary();
            
            REFRESH_CONFIG.stocks.lastUpdate = Date.now();
            if (domCache.lastUpdate) domCache.lastUpdate.textContent = new Date().toLocaleTimeString();
            
            const statusMessage = `✅ Updated: ${liveCount}/${energyCompanies.length} live`;
            updateStatus(statusMessage);
            updateApiStats();
            
            if (domCache.refreshAllBtn) domCache.refreshAllBtn.disabled = false;
            log(`✅ Stock update complete: ${liveCount} live`);
        }

        // ============= CONTROL FUNCTIONS =============
        function addSymbol() {
            const input = domCache.symbolInput;
            if (!input) return;
            
            const symbol = sanitizeSymbol(input.value.trim().toUpperCase());
            
            if (symbol && !energyCompanies.includes(symbol)) {
                energyCompanies.push(symbol);
                priceHistory[symbol] = [];
                input.value = '';
                
                // Update immediately for new symbol
                updateStocks();
                
                log(`➕ Added symbol: ${symbol}`);
            }
        }

        function toggleUpdates() {
            isUpdating = !isUpdating;
            
            if (domCache.toggleBtn) {
                domCache.toggleBtn.textContent = isUpdating ? '⏸️ Pause' : '▶️ Resume';
            }
            
            if (isUpdating) {
                startIntervals();
                updateStatus('🔄 Live updates resumed');
            } else {
                stopIntervals();
                updateStatus('⏸️ Updates paused');
            }
            
            log(`${isUpdating ? '▶️ Resumed' : '⏸️ Paused'} updates`);
        }

        function refreshAll() {
            log('🔄 Manual refresh triggered');
            updateStocks();
            fetchNews();
        }

        function startIntervals() {
            stockInterval = setInterval(updateStocks, REFRESH_CONFIG.stocks.interval);
            newsInterval = setInterval(fetchNews, REFRESH_CONFIG.news.interval);
        }

        function stopIntervals() {
            clearInterval(stockInterval);
            clearInterval(newsInterval);
        }

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Energy Equities Terminal starting...');
            
            // Initialize DOM cache
            initializeDomCache();
            
            // Set up event listeners
            if (domCache.symbolInput) {
                domCache.symbolInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addSymbol();
                    }
                });
            }

            // Start the application
            updateStatus('🔌 Connecting to market data...');
            
            // Initial data load
            updateStocks();
            fetchNews();
            
            // Set up intervals
            startIntervals();
            
            log('✅ Terminal ready');
        });
    </script>
</body>
</html>
